import chex
import jax.numpy as jnp

from jaxborg.actions.red_common import apply_exploit_success, exploit_common_preconditions
from jaxborg.constants import ACTIVITY_EXPLOIT, DECOY_IDS, SERVICE_IDS
from jaxborg.state import CC4Const, CC4State

SSH_SERVICE_IDX = SERVICE_IDS["SSHD"]
APACHE_SERVICE_IDX = SERVICE_IDS["APACHE2"]
MYSQL_SERVICE_IDX = SERVICE_IDS["MYSQLD"]
SMTP_SERVICE_IDX = SERVICE_IDS["SMTP"]

DECOY_HARAKA_IDX = DECOY_IDS["HarakaSMPT"]
DECOY_APACHE_IDX = DECOY_IDS["Apache"]
DECOY_TOMCAT_IDX = DECOY_IDS["Tomcat"]
DECOY_VSFTPD_IDX = DECOY_IDS["Vsftpd"]


def apply_exploit_ssh(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_ssh = state.host_services[target_host, SSH_SERVICE_IDX]
    has_bruteforceable = const.host_has_bruteforceable_user[target_host]
    success = base_ok & has_ssh & has_bruteforceable
    return apply_exploit_success(state, const, agent_id, target_host, success)


def apply_exploit_ftp(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_decoy = state.host_decoys[target_host, DECOY_VSFTPD_IDX]
    detected = base_ok & has_decoy
    activity = jnp.where(
        detected,
        state.red_activity_this_step.at[target_host].set(ACTIVITY_EXPLOIT),
        state.red_activity_this_step,
    )
    return state.replace(red_activity_this_step=activity)


def apply_exploit_http(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_apache = state.host_services[target_host, APACHE_SERVICE_IDX]
    has_rfi = const.host_has_rfi[target_host]
    has_decoy = state.host_decoys[target_host, DECOY_APACHE_IDX]
    detected = base_ok & has_apache & has_decoy
    success = base_ok & has_apache & has_rfi & ~has_decoy
    activity = jnp.where(
        detected,
        state.red_activity_this_step.at[target_host].set(ACTIVITY_EXPLOIT),
        state.red_activity_this_step,
    )
    state = state.replace(red_activity_this_step=activity)
    return apply_exploit_success(state, const, agent_id, target_host, success)


def apply_exploit_https(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_decoy = state.host_decoys[target_host, DECOY_TOMCAT_IDX]
    detected = base_ok & has_decoy
    activity = jnp.where(
        detected,
        state.red_activity_this_step.at[target_host].set(ACTIVITY_EXPLOIT),
        state.red_activity_this_step,
    )
    return state.replace(red_activity_this_step=activity)


def apply_exploit_haraka(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_smtp = state.host_services[target_host, SMTP_SERVICE_IDX]
    has_decoy = state.host_decoys[target_host, DECOY_HARAKA_IDX]
    detected = base_ok & has_smtp & has_decoy
    activity = jnp.where(
        detected,
        state.red_activity_this_step.at[target_host].set(ACTIVITY_EXPLOIT),
        state.red_activity_this_step,
    )
    return state.replace(red_activity_this_step=activity)


def apply_exploit_sql(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    base_ok = exploit_common_preconditions(state, const, agent_id, target_host)
    has_mysql = state.host_services[target_host, MYSQL_SERVICE_IDX]
    has_web = state.host_services[target_host, APACHE_SERVICE_IDX]
    success = base_ok & has_mysql & has_web
    return apply_exploit_success(state, const, agent_id, target_host, success)


def apply_exploit_eternalblue(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    return state


def apply_exploit_bluekeep(
    state: CC4State,
    const: CC4Const,
    agent_id: int,
    target_host: chex.Array,
) -> CC4State:
    return state
