import jax
import jax.numpy as jnp
import numpy as np
import pytest

from jaxborg.actions import apply_red_action
from jaxborg.actions.encoding import (
    ACTION_TYPE_EXPLOIT_BLUEKEEP,
    ACTION_TYPE_EXPLOIT_ETERNALBLUE,
    ACTION_TYPE_EXPLOIT_FTP,
    ACTION_TYPE_EXPLOIT_HARAKA,
    ACTION_TYPE_EXPLOIT_HTTP,
    ACTION_TYPE_EXPLOIT_HTTPS,
    ACTION_TYPE_EXPLOIT_SQL,
    RED_EXPLOIT_BLUEKEEP_END,
    RED_EXPLOIT_BLUEKEEP_START,
    RED_EXPLOIT_ETERNALBLUE_END,
    RED_EXPLOIT_ETERNALBLUE_START,
    RED_EXPLOIT_FTP_END,
    RED_EXPLOIT_FTP_START,
    RED_EXPLOIT_HARAKA_END,
    RED_EXPLOIT_HARAKA_START,
    RED_EXPLOIT_HTTP_END,
    RED_EXPLOIT_HTTP_START,
    RED_EXPLOIT_HTTPS_END,
    RED_EXPLOIT_HTTPS_START,
    RED_EXPLOIT_SQL_END,
    RED_EXPLOIT_SQL_START,
    RED_EXPLOIT_SSH_END,
    decode_red_action,
    encode_red_action,
)
from jaxborg.constants import (
    ACTIVITY_EXPLOIT,
    COMPROMISE_USER,
    DECOY_IDS,
    GLOBAL_MAX_HOSTS,
    NUM_RED_AGENTS,
    SERVICE_IDS,
)
from jaxborg.state import create_initial_state
from jaxborg.topology import build_topology


@pytest.fixture
def jax_const():
    return build_topology(jnp.array([42]), num_steps=500)


def _setup_scanned_state(jax_const, target_host):
    state = create_initial_state()
    state = state.replace(host_services=jnp.array(jax_const.initial_services))
    start_host = int(jax_const.red_start_hosts[0])
    red_sessions = state.red_sessions.at[0, start_host].set(True)
    red_session_is_abstract = state.red_session_is_abstract.at[0, start_host].set(True)
    state = state.replace(red_sessions=red_sessions, red_session_is_abstract=red_session_is_abstract)

    target_subnet = int(jax_const.host_subnet[target_host])
    discover_idx = encode_red_action("DiscoverRemoteSystems", target_subnet, 0)
    state = apply_red_action(state, jax_const, 0, discover_idx, jax.random.PRNGKey(0))
    state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))

    scan_idx = encode_red_action("DiscoverNetworkServices", target_host, 0)
    state = apply_red_action(state, jax_const, 0, scan_idx, jax.random.PRNGKey(0))
    state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))
    return state


def _find_host_with_service(jax_const, service_idx, exclude_start=True):
    for h in range(jax_const.num_hosts):
        if jax_const.host_active[h] and not jax_const.host_is_router[h] and jax_const.initial_services[h, service_idx]:
            if exclude_start and h == int(jax_const.red_start_hosts[0]):
                continue
            return h
    return None


def _find_host_with_services(jax_const, service_indices, exclude_start=True):
    for h in range(jax_const.num_hosts):
        if not jax_const.host_active[h] or jax_const.host_is_router[h]:
            continue
        if exclude_start and h == int(jax_const.red_start_hosts[0]):
            continue
        if all(jax_const.initial_services[h, idx] for idx in service_indices):
            return h
    return None


class TestExploitRangeLayout:
    def test_ftp_range_starts_after_ssh(self):
        assert RED_EXPLOIT_FTP_START == RED_EXPLOIT_SSH_END

    def test_ranges_contiguous(self):
        assert RED_EXPLOIT_HTTP_START == RED_EXPLOIT_FTP_END
        assert RED_EXPLOIT_HTTPS_START == RED_EXPLOIT_HTTP_END
        assert RED_EXPLOIT_HARAKA_START == RED_EXPLOIT_HTTPS_END
        assert RED_EXPLOIT_SQL_START == RED_EXPLOIT_HARAKA_END
        assert RED_EXPLOIT_ETERNALBLUE_START == RED_EXPLOIT_SQL_END
        assert RED_EXPLOIT_BLUEKEEP_START == RED_EXPLOIT_ETERNALBLUE_END

    def test_each_range_is_max_hosts_wide(self):
        for start, end in [
            (RED_EXPLOIT_FTP_START, RED_EXPLOIT_FTP_END),
            (RED_EXPLOIT_HTTP_START, RED_EXPLOIT_HTTP_END),
            (RED_EXPLOIT_HTTPS_START, RED_EXPLOIT_HTTPS_END),
            (RED_EXPLOIT_HARAKA_START, RED_EXPLOIT_HARAKA_END),
            (RED_EXPLOIT_SQL_START, RED_EXPLOIT_SQL_END),
            (RED_EXPLOIT_ETERNALBLUE_START, RED_EXPLOIT_ETERNALBLUE_END),
            (RED_EXPLOIT_BLUEKEEP_START, RED_EXPLOIT_BLUEKEEP_END),
        ]:
            assert end - start == GLOBAL_MAX_HOSTS


class TestExploitEncoding:
    @pytest.mark.parametrize(
        "action_name,start,atype",
        [
            ("ExploitRemoteService_cc4FTPDirectoryTraversal", RED_EXPLOIT_FTP_START, ACTION_TYPE_EXPLOIT_FTP),
            ("ExploitRemoteService_cc4HTTPRFI", RED_EXPLOIT_HTTP_START, ACTION_TYPE_EXPLOIT_HTTP),
            ("ExploitRemoteService_cc4HTTPSRFI", RED_EXPLOIT_HTTPS_START, ACTION_TYPE_EXPLOIT_HTTPS),
            ("ExploitRemoteService_cc4HarakaRCE", RED_EXPLOIT_HARAKA_START, ACTION_TYPE_EXPLOIT_HARAKA),
            ("ExploitRemoteService_cc4SQLInjection", RED_EXPLOIT_SQL_START, ACTION_TYPE_EXPLOIT_SQL),
            ("ExploitRemoteService_cc4EternalBlue", RED_EXPLOIT_ETERNALBLUE_START, ACTION_TYPE_EXPLOIT_ETERNALBLUE),
            ("ExploitRemoteService_cc4BlueKeep", RED_EXPLOIT_BLUEKEEP_START, ACTION_TYPE_EXPLOIT_BLUEKEEP),
        ],
    )
    def test_encode_decode_roundtrip(self, jax_const, action_name, start, atype):
        for h in [0, 5, GLOBAL_MAX_HOSTS - 1]:
            code = encode_red_action(action_name, h, 0)
            assert code == start + h
            action_type, _, target_host = decode_red_action(code, 0, jax_const)
            assert int(action_type) == atype
            assert int(target_host) == h


class TestExploitSQL:
    def test_sql_succeeds_with_mysql_and_apache(self, jax_const):
        target = _find_host_with_services(jax_const, [SERVICE_IDS["MYSQLD"], SERVICE_IDS["APACHE2"]])
        if target is None:
            pytest.skip("No host with both MYSQLD and APACHE2")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        assert bool(new_state.red_sessions[0, target])
        assert int(new_state.red_privilege[0, target]) == COMPROMISE_USER
        assert int(new_state.host_compromised[target]) == COMPROMISE_USER
        assert bool(new_state.host_has_malware[target])
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT

    def test_sql_fails_without_apache(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["MYSQLD"])
        if target is None:
            pytest.skip("No host with MYSQLD")

        state = _setup_scanned_state(jax_const, target)
        services = state.host_services.at[target, SERVICE_IDS["APACHE2"]].set(False)
        state = state.replace(host_services=services)

        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_sql_fails_without_mysql(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        state = _setup_scanned_state(jax_const, target)
        services = state.host_services.at[target, SERVICE_IDS["MYSQLD"]].set(False)
        state = state.replace(host_services=services)

        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_sql_fails_without_scan(self, jax_const):
        target = _find_host_with_services(jax_const, [SERVICE_IDS["MYSQLD"], SERVICE_IDS["APACHE2"]])
        if target is None:
            pytest.skip("No host with both MYSQLD and APACHE2")

        state = create_initial_state()
        state = state.replace(host_services=jnp.array(jax_const.initial_services))
        start_host = int(jax_const.red_start_hosts[0])
        red_sessions = state.red_sessions.at[0, start_host].set(True)
        state = state.replace(red_sessions=red_sessions)

        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_sql_repeat_attempt_with_existing_session(self, jax_const):
        target = _find_host_with_services(jax_const, [SERVICE_IDS["MYSQLD"], SERVICE_IDS["APACHE2"]])
        if target is None:
            pytest.skip("No host with both MYSQLD and APACHE2")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        state1 = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert bool(state1.red_sessions[0, target])

        state1 = state1.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))
        state2 = apply_red_action(state1, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert int(state2.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


class TestExploitHTTP:
    def test_http_fails_without_rfi(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4HTTPRFI", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_http_succeeds_with_rfi(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        const = jax_const.replace(host_has_rfi=jax_const.host_has_rfi.at[target].set(True))
        state = _setup_scanned_state(const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4HTTPRFI", target, 0)
        new_state = apply_red_action(state, const, 0, action_idx, jax.random.PRNGKey(0))

        assert bool(new_state.red_sessions[0, target])
        assert int(new_state.red_privilege[0, target]) == COMPROMISE_USER

    def test_http_blocked_by_apache_decoy(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        const = jax_const.replace(host_has_rfi=jax_const.host_has_rfi.at[target].set(True))
        state = _setup_scanned_state(const, target)
        decoys = state.host_decoys.at[target, DECOY_IDS["Apache"]].set(True)
        state = state.replace(host_decoys=decoys)

        action_idx = encode_red_action("ExploitRemoteService_cc4HTTPRFI", target, 0)
        new_state = apply_red_action(state, const, 0, action_idx, jax.random.PRNGKey(0))

        assert not bool(new_state.red_sessions[0, target])
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


class TestExploitHTTPS:
    def test_https_always_fails_no_service(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4HTTPSRFI", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_https_detected_by_tomcat_decoy(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["APACHE2"])
        if target is None:
            pytest.skip("No host with APACHE2")

        state = _setup_scanned_state(jax_const, target)
        decoys = state.host_decoys.at[target, DECOY_IDS["Tomcat"]].set(True)
        state = state.replace(host_decoys=decoys)

        action_idx = encode_red_action("ExploitRemoteService_cc4HTTPSRFI", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        assert not bool(new_state.red_sessions[0, target])
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


class TestExploitHaraka:
    def test_haraka_fails_no_vulnerable_version(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SMTP"])
        if target is None:
            pytest.skip("No host with SMTP")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4HarakaRCE", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_haraka_detected_by_decoy(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SMTP"])
        if target is None:
            pytest.skip("No host with SMTP")

        state = _setup_scanned_state(jax_const, target)
        decoys = state.host_decoys.at[target, DECOY_IDS["HarakaSMPT"]].set(True)
        state = state.replace(host_decoys=decoys)

        action_idx = encode_red_action("ExploitRemoteService_cc4HarakaRCE", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        assert not bool(new_state.red_sessions[0, target])
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


class TestExploitFTP:
    def test_ftp_always_fails_no_service(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SSHD"])
        if target is None:
            pytest.skip("No exploitable host")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4FTPDirectoryTraversal", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_ftp_detected_by_vsftpd_decoy(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SSHD"])
        if target is None:
            pytest.skip("No exploitable host")

        state = _setup_scanned_state(jax_const, target)
        decoys = state.host_decoys.at[target, DECOY_IDS["Vsftpd"]].set(True)
        state = state.replace(host_decoys=decoys)

        action_idx = encode_red_action("ExploitRemoteService_cc4FTPDirectoryTraversal", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        assert not bool(new_state.red_sessions[0, target])
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


class TestExploitEternalBlueBlueKeep:
    def test_eternalblue_always_fails(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SSHD"])
        if target is None:
            pytest.skip("No exploitable host")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4EternalBlue", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_bluekeep_always_fails(self, jax_const):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SSHD"])
        if target is None:
            pytest.skip("No exploitable host")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4BlueKeep", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])


class TestExploitJIT:
    @pytest.mark.parametrize(
        "action_name",
        [
            "ExploitRemoteService_cc4FTPDirectoryTraversal",
            "ExploitRemoteService_cc4HTTPRFI",
            "ExploitRemoteService_cc4HTTPSRFI",
            "ExploitRemoteService_cc4HarakaRCE",
            "ExploitRemoteService_cc4SQLInjection",
            "ExploitRemoteService_cc4EternalBlue",
            "ExploitRemoteService_cc4BlueKeep",
        ],
    )
    def test_jit_compatible(self, jax_const, action_name):
        target = _find_host_with_service(jax_const, SERVICE_IDS["SSHD"])
        if target is None:
            pytest.skip("No exploitable host")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action(action_name, target, 0)
        jitted = jax.jit(apply_red_action, static_argnums=(2,))
        new_state = jitted(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert new_state.red_sessions.shape == state.red_sessions.shape


class TestExploitDoesNotAffectOtherAgents:
    def test_sql_only_affects_acting_agent(self, jax_const):
        target = _find_host_with_services(jax_const, [SERVICE_IDS["MYSQLD"], SERVICE_IDS["APACHE2"]])
        if target is None:
            pytest.skip("No host with both MYSQLD and APACHE2")

        state = _setup_scanned_state(jax_const, target)
        action_idx = encode_red_action("ExploitRemoteService_cc4SQLInjection", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        for agent in range(1, NUM_RED_AGENTS):
            np.testing.assert_array_equal(
                np.array(new_state.red_sessions[agent]),
                np.array(state.red_sessions[agent]),
            )
            np.testing.assert_array_equal(
                np.array(new_state.red_privilege[agent]),
                np.array(state.red_privilege[agent]),
            )
