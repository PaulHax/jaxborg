import jax
import jax.numpy as jnp
import numpy as np
import pytest

from jaxborg.actions import apply_red_action
from jaxborg.actions.encoding import (
    ACTION_TYPE_EXPLOIT_SSH,
    RED_EXPLOIT_SSH_START,
    decode_red_action,
    encode_red_action,
)
from jaxborg.constants import (
    ACTIVITY_EXPLOIT,
    ACTIVITY_NONE,
    COMPROMISE_USER,
    GLOBAL_MAX_HOSTS,
    NUM_RED_AGENTS,
    NUM_SUBNETS,
    SERVICE_IDS,
)
from jaxborg.state import create_initial_state
from jaxborg.topology import CYBORG_SUFFIX_TO_ID, build_topology

try:
    from CybORG import CybORG
    from CybORG.Agents import SleepAgent
    from CybORG.Simulator.Actions import DiscoverRemoteSystems
    from CybORG.Simulator.Actions.AbstractActions.DiscoverNetworkServices import (
        AggressiveServiceDiscovery,
    )
    from CybORG.Simulator.Actions.AbstractActions.ExploitRemoteService import (
        ExploitRemoteService,
    )
    from CybORG.Simulator.Scenarios import EnterpriseScenarioGenerator

    HAS_CYBORG = True
except ImportError:
    HAS_CYBORG = False

cyborg_required = pytest.mark.skipif(not HAS_CYBORG, reason="CybORG not installed")

SSH_SVC = SERVICE_IDS["SSHD"]


@pytest.fixture
def jax_const():
    return build_topology(jnp.array([42]), num_steps=500)


def _setup_scanned_state(jax_const):
    """Discover + scan a target host so it's ready for exploit."""
    state = create_initial_state()
    state = state.replace(host_services=jnp.array(jax_const.initial_services))

    start_host = int(jax_const.red_start_hosts[0])
    red_sessions = state.red_sessions.at[0, start_host].set(True)
    state = state.replace(red_sessions=red_sessions)

    start_subnet = int(jax_const.host_subnet[start_host])
    discover_idx = encode_red_action("DiscoverRemoteSystems", start_subnet, 0)
    state = apply_red_action(state, jax_const, 0, discover_idx, jax.random.PRNGKey(0))
    state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))

    target = _first_exploitable_host(jax_const, state)
    if target is None:
        return state, None

    scan_idx = encode_red_action("DiscoverNetworkServices", target, 0)
    state = apply_red_action(state, jax_const, 0, scan_idx, jax.random.PRNGKey(0))
    state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))
    return state, target


def _first_exploitable_host(jax_const, state, agent_id=0):
    discovered = np.array(state.red_discovered_hosts[agent_id])
    services = np.array(state.host_services) if state.host_services.any() else np.array(jax_const.initial_services)
    for h in range(jax_const.num_hosts):
        if (
            discovered[h]
            and not jax_const.host_is_router[h]
            and services[h, SSH_SVC]
            and jax_const.host_has_bruteforceable_user[h]
            and h != int(jax_const.red_start_hosts[agent_id])
        ):
            return h
    return None


@pytest.fixture
def scanned_state(jax_const):
    state, target = _setup_scanned_state(jax_const)
    assert target is not None, "No exploitable host found"
    return state, target


class TestExploitSSHEncoding:
    def test_encode_per_host(self):
        for h in range(10):
            code = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", h, 0)
            assert code == RED_EXPLOIT_SSH_START + h

    def test_decode_roundtrip(self, jax_const):
        for h in [0, 5, 50, GLOBAL_MAX_HOSTS - 1]:
            code = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", h, 0)
            action_type, target_subnet, target_host = decode_red_action(code, 0, jax_const)
            assert int(action_type) == ACTION_TYPE_EXPLOIT_SSH
            assert int(target_subnet) == -1
            assert int(target_host) == h

    def test_exploit_range_does_not_overlap_scan(self):
        from jaxborg.actions.encoding import RED_SCAN_END

        assert RED_EXPLOIT_SSH_START == RED_SCAN_END


class TestApplyExploitSSH:
    def test_exploit_creates_session(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert bool(new_state.red_sessions[0, target])

    def test_exploit_sets_user_privilege(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert int(new_state.red_privilege[0, target]) == COMPROMISE_USER

    def test_exploit_sets_host_compromised(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert int(new_state.host_compromised[target]) == COMPROMISE_USER

    def test_exploit_sets_malware(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert bool(new_state.host_has_malware[target])

    def test_exploit_sets_activity(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert int(new_state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT

    def test_exploit_fails_without_scan(self, jax_const):
        state = create_initial_state()
        state = state.replace(host_services=jnp.array(jax_const.initial_services))
        start_host = int(jax_const.red_start_hosts[0])
        red_sessions = state.red_sessions.at[0, start_host].set(True)
        state = state.replace(red_sessions=red_sessions)

        start_subnet = int(jax_const.host_subnet[start_host])
        discover_idx = encode_red_action("DiscoverRemoteSystems", start_subnet, 0)
        state = apply_red_action(state, jax_const, 0, discover_idx, jax.random.PRNGKey(0))

        target = _first_exploitable_host(jax_const, state)
        if target is None:
            pytest.skip("No exploitable host found")

        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_exploit_fails_without_session(self, jax_const):
        state = create_initial_state()
        state = state.replace(host_services=jnp.array(jax_const.initial_services))
        discovered = state.red_discovered_hosts.at[0, 5].set(True)
        scanned = state.red_scanned_hosts.at[0, 5].set(True)
        state = state.replace(red_discovered_hosts=discovered, red_scanned_hosts=scanned)

        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", 5, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, 5])

    def test_exploit_fails_without_ssh_service(self, jax_const, scanned_state):
        state, target = scanned_state
        services = state.host_services.at[target, SSH_SVC].set(False)
        state = state.replace(host_services=services)

        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_exploit_fails_without_bruteforceable_user(self, jax_const, scanned_state):
        state, target = scanned_state
        const = jax_const.replace(
            host_has_bruteforceable_user=jax_const.host_has_bruteforceable_user.at[target].set(False)
        )

        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_exploit_noop_when_already_has_session(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)

        state1 = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert bool(state1.red_sessions[0, target])

        state1 = state1.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))
        state2 = apply_red_action(state1, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert int(state2.red_activity_this_step[target]) == ACTIVITY_NONE

    def test_exploit_only_affects_target(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        start_host = int(jax_const.red_start_hosts[0])
        for h in range(jax_const.num_hosts):
            if h == target or h == start_host:
                continue
            assert not bool(new_state.red_sessions[0, h]) or bool(state.red_sessions[0, h])
            assert int(new_state.host_compromised[h]) == int(state.host_compromised[h])
            assert bool(new_state.host_has_malware[h]) == bool(state.host_has_malware[h])

    def test_exploit_does_not_affect_other_agents(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))

        for agent in range(1, NUM_RED_AGENTS):
            np.testing.assert_array_equal(
                np.array(new_state.red_sessions[agent]),
                np.array(state.red_sessions[agent]),
            )
            np.testing.assert_array_equal(
                np.array(new_state.red_privilege[agent]),
                np.array(state.red_privilege[agent]),
            )

    def test_exploit_blocked_zone_fails(self, jax_const, scanned_state):
        state, target = scanned_state
        blocked = jnp.ones((NUM_SUBNETS, NUM_SUBNETS), dtype=jnp.bool_)
        state = state.replace(blocked_zones=blocked)

        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        new_state = apply_red_action(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert not bool(new_state.red_sessions[0, target])

    def test_jit_compatible(self, jax_const, scanned_state):
        state, target = scanned_state
        action_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0)
        jitted = jax.jit(apply_red_action, static_argnums=(2,))
        new_state = jitted(state, jax_const, 0, action_idx, jax.random.PRNGKey(0))
        assert bool(new_state.red_sessions[0, target])
        assert int(new_state.red_privilege[0, target]) == COMPROMISE_USER


class TestExploitSSHChain:
    def test_discover_scan_exploit_chain(self, jax_const):
        state = create_initial_state()
        state = state.replace(host_services=jnp.array(jax_const.initial_services))

        start_host = int(jax_const.red_start_hosts[0])
        red_sessions = state.red_sessions.at[0, start_host].set(True)
        state = state.replace(red_sessions=red_sessions)

        start_subnet = int(jax_const.host_subnet[start_host])
        state = apply_red_action(
            state,
            jax_const,
            0,
            encode_red_action("DiscoverRemoteSystems", start_subnet, 0),
            jax.random.PRNGKey(0),
        )

        target = _first_exploitable_host(jax_const, state)
        assert target is not None

        state = apply_red_action(
            state,
            jax_const,
            0,
            encode_red_action("DiscoverNetworkServices", target, 0),
            jax.random.PRNGKey(0),
        )

        state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))
        state = apply_red_action(
            state,
            jax_const,
            0,
            encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target, 0),
            jax.random.PRNGKey(0),
        )

        assert bool(state.red_sessions[0, target])
        assert int(state.red_privilege[0, target]) == COMPROMISE_USER
        assert int(state.host_compromised[target]) == COMPROMISE_USER
        assert bool(state.host_has_malware[target])
        assert int(state.red_activity_this_step[target]) == ACTIVITY_EXPLOIT


@cyborg_required
class TestDifferentialWithCybORG:
    @pytest.fixture
    def cyborg_env(self):
        sg = EnterpriseScenarioGenerator(
            blue_agent_class=SleepAgent,
            green_agent_class=SleepAgent,
            red_agent_class=SleepAgent,
            steps=500,
        )
        return CybORG(scenario_generator=sg, seed=42)

    @pytest.fixture
    def cyborg_and_jax(self, cyborg_env):
        from jaxborg.topology import build_const_from_cyborg

        const = build_const_from_cyborg(cyborg_env)
        state = create_initial_state()
        state = state.replace(host_services=jnp.array(const.initial_services))
        start_host = int(const.red_start_hosts[0])
        red_sessions = state.red_sessions.at[0, start_host].set(True)
        state = state.replace(red_sessions=red_sessions)
        return cyborg_env, const, state

    def test_ssh_exploit_success_matches_cyborg(self, cyborg_and_jax):
        cyborg_env, const, state = cyborg_and_jax
        cyborg_state = cyborg_env.environment_controller.state
        sorted_hosts = sorted(cyborg_state.hosts.keys())

        subnet_name = "contractor_network_subnet"
        subnet_cidr = cyborg_state.subnet_name_to_cidr[subnet_name]
        sid = CYBORG_SUFFIX_TO_ID[subnet_name]

        discover_action = DiscoverRemoteSystems(subnet=subnet_cidr, session=0, agent="red_agent_0")
        discover_action.duration = 1
        cyborg_env.step(agent="red_agent_0", action=discover_action)

        discover_idx = encode_red_action("DiscoverRemoteSystems", sid, 0)
        state = apply_red_action(state, const, 0, discover_idx, jax.random.PRNGKey(0))
        state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))

        discovered_jax = np.array(state.red_discovered_hosts[0])
        exploitable = [
            h
            for h in range(const.num_hosts)
            if (
                discovered_jax[h]
                and not const.host_is_router[h]
                and const.initial_services[h, SSH_SVC]
                and const.host_has_bruteforceable_user[h]
                and h != int(const.red_start_hosts[0])
            )
        ]
        assert len(exploitable) > 0, "No exploitable hosts found"
        target_h = exploitable[0]
        target_hostname = sorted_hosts[target_h]

        target_ip = None
        for ip, hostname in cyborg_state.ip_addresses.items():
            if hostname == target_hostname:
                target_ip = ip
                break
        assert target_ip is not None

        scan_action = AggressiveServiceDiscovery(session=0, agent="red_agent_0", ip_address=target_ip)
        scan_action.duration = 1
        cyborg_env.step(agent="red_agent_0", action=scan_action)

        scan_idx = encode_red_action("DiscoverNetworkServices", target_h, 0)
        state = apply_red_action(state, const, 0, scan_idx, jax.random.PRNGKey(0))
        state = state.replace(red_activity_this_step=jnp.zeros(GLOBAL_MAX_HOSTS, dtype=jnp.int32))

        exploit_action = ExploitRemoteService(ip_address=target_ip, session=0, agent="red_agent_0")
        exploit_action.duration = 1
        cyborg_result = cyborg_env.step(agent="red_agent_0", action=exploit_action)
        cyborg_success = cyborg_result.observation.get("success") == True  # noqa: E712

        exploit_idx = encode_red_action("ExploitRemoteService_cc4SSHBruteForce", target_h, 0)
        new_state = apply_red_action(state, const, 0, exploit_idx, jax.random.PRNGKey(0))

        jax_success = bool(new_state.red_sessions[0, target_h])

        assert jax_success == cyborg_success, (
            f"JAX exploit success={jax_success} but CybORG={cyborg_success} for host {target_h} ({target_hostname})"
        )

        if cyborg_success:
            assert int(new_state.host_compromised[target_h]) >= COMPROMISE_USER
            assert bool(new_state.host_has_malware[target_h])
